<ion-header>
  <ion-navbar dark class="task-detail-toolbar">
    <ion-title>{{task.name}}</ion-title>
    <ion-buttons end>
      <button ion-button icon-only color="primary" (click)="taskActionSheet($event)">
        <ion-icon name="cube"></ion-icon>
      </button>
    </ion-buttons>
  </ion-navbar>
</ion-header>

<ion-content class="task-detail" >

  <div class="ion-segment-container">
    <ion-segment [(ngModel)]="moduleView" >
      <ion-segment-button *ngFor="let module of data; let m = index" [value]="m"
      [ngStyle]="{'color': data[m].options.color,
                  'border-color':  m === moduleView ?
                    data[m].options.color
                  : 'transparent',
                  'background': m === moduleView ?
                    convertRGBA(data[m].options.color,0.15)
                  : 'rgba(10,9,4,0.5)'
                 }">
        {{data[m].control}}
      </ion-segment-button>
    </ion-segment>
  </div>
  <div class="ui-splitbar"></div>
  <div class="chart-container" >
    <canvas baseChart class="chart"
    [datasets]="lineChartData"
    [options]="lineChartOptions"
    [colors]="lineChartColours"
    [chartType]="'line'"
    (chartHover)="chartHovered()"
    (chartClick)="chartClicked()"
    [style.height]="chartHeight + 'px'">
    </canvas>
  </div>

  <div class="segment-splitbar">
    <span (pan)="dragSplitbar($event)" class="dragHandler">
      ...
    </span>
  </div>

  <div scrollY="true">

    <ion-grid *ngIf="!showMiniBar" class="mini-bar">
      <ion-row>
        <ion-col>
          <button ion-button full class="rb-glass"
          (click)="data[moduleView].options.fill = !data[moduleView].options.fill; updateChart()"
          [ngClass]="{'active': data[moduleView].options.fill}">
            <ion-icon name="color-fill"></ion-icon>
            <span class="minibar-button-txt">Fill</span>
          </button>
        </ion-col>
        <ion-col>
          <button ion-button full class="rb-glass"
          (click)="data[moduleView].show = !data[moduleView].show; updateChart()"
          [ngClass]="{'active': data[moduleView].show}">
            <ion-icon name="eye"></ion-icon>
            <span class="minibar-button-txt">Show</span>
          </button>
        </ion-col>
        <ion-col>
          <button ion-button full class="rb-glass"
          (click)="data[moduleView].options.yAxisID = data[moduleView].options.yAxisID === 'y-axis-1' ? 'y-axis-2' : 'y-axis-1'; updateChart()"
          [ngClass]="{'active': data[moduleView].options.yAxisID === 'y-axis-2'}">
            <b>y2</b>
            <span class="minibar-button-txt">Axis</span>
          </button>
        </ion-col>
        <ion-col>
          <button ion-button full class="rb-glass"
          (click)="editStrokeWidth = !editStrokeWidth"
          [ngClass]="{'active': editStrokeWidth}">
            <ion-icon name="brush"></ion-icon>
            <span class="minibar-button-txt">Size</span>
          </button>
        </ion-col>
        <ion-col *ngIf="editStrokeWidth" class="mb-input">
          <input type="number" min="1" max="10" autocomplete="off"
          [(ngModel)]="data[moduleView].options.strokeWidth"
          (ngModelChange)="updateChart()"/>
        </ion-col>
        <ion-col>
          <button ion-button full class="rb-glass"
          (click)="editPointSize = !editPointSize"
          [ngClass]="{'active': editPointSize}">
            <ion-icon name="disc"></ion-icon>
            <span class="minibar-button-txt">Size</span>
          </button>
        </ion-col>
        <ion-col *ngIf="editPointSize" class="mb-input">
          <input type="number" min="0" max="25" autocomplete="off"
          [(ngModel)]="data[moduleView].options.pointRadius"
          (ngModelChange)="updateChart()"/>
        </ion-col>
        <ion-col>
          <button ion-button full class="rb-glass"
            (click)="presentPopover($event)">
            <ion-icon name="watch"></ion-icon>
            <span class="minibar-button-txt">Time</span>
          </button>
        </ion-col>
      </ion-row>
    </ion-grid>


    <table class="md-table">
      <thead>
        <tr>
          <td style="width: 42px; height: 42px;">
            <button ion-button icon-only class="rb-glass"
            [ngStyle]="{'color': data[moduleView].options.color}"
            (click)="taskActionSheet($event)">
              <ion-icon full name="color-palette"></ion-icon>
            </button>
          </td>
          <td style="width: 110px">Time</td>
          <td style="width: 110px;">Target</td>
          <td>Slope</td>
          <td>Notes</td>
          <td style="width: 42px; height: 42px;">
            <button ion-button icon-only class="rb-glass"
            (click)="showMiniBar = !showMiniBar">
              <ion-icon full name="switch"></ion-icon>
            </button>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let point of data[moduleView].points; let p = index" >
          <td class="index" [ngStyle]="{'color': data[moduleView].options.color}">
            {{p+1}}
          </td>
          <td>
            <input type="number" required min="0" ng-min="data[moduleView].points[p-1][0]"
            [(ngModel)]="point[0]"
            (ngModelChange)="updateChart()"/>
          </td>
          <td>
            <input type="number" required
            [(ngModel)]="point[1]"
            (ngModelChange)="updateChart()"/>
          </td>
          <td>
            °C/s
          </td>
          <td>
            <input type="text"
            [(ngModel)]="data[moduleView].note"
            (ngModelChange)="updateChart()"/>
          </td>
          <td class="action-button-col">
            <button ion-button icon-only class="rb-red"
            (click)="dropPoint(data[moduleView].points, point)">
              <ion-icon name="trash"></ion-icon>
            </button>
          </td>
        </tr>
        <tr style="background: rgba(0,0,0,0.7) !important">
          <td class="index" [ngStyle]="{'color': data[moduleView].options.color}">
            <ion-icon name="arrow-round-forward"></ion-icon>
          </td>
          <td>
            <input type="number" />
          </td>
          <td>
            <input type="number" />
          </td>
          <td> °C/s</td>
          <td>
            <input type="text" value="" />
          </td>
          <td class="action-button-col">
            <button ion-button icon-only (click)="dropPoint(data[moduleView].points, point)">
              <ion-icon name="add"></ion-icon>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</ion-content>
